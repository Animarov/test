<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Clicker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(to bottom, #ffffff, #fff5e6, #ffedd5, #ffe4bc);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: #7c2d12;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        /* Анимированные падающие листья */
        .leaf {
            position: absolute;
            width: 30px;
            height: 30px;
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 0.7;
            z-index: 0;
            top: -50px;
            animation: fall linear infinite;
        }
        
        .leaf1 { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ea580c'%3E%3Cpath d='M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM15.9 8.1C15.5 7.7 14.8 7.5 14.2 7.8L12 9L9.8 7.8C9.2 7.5 8.5 7.7 8.1 8.1C7.7 8.5 7.5 9.2 7.8 9.8L9 12L7.8 14.2C7.5 14.8 7.7 15.5 8.1 15.9C8.5 16.3 9.2 16.5 9.8 16.2L12 15L14.2 16.2C14.8 16.5 15.5 16.3 15.9 15.9C16.3 15.5 16.5 14.8 16.2 14.2L15 12L16.2 9.8C16.5 9.2 16.3 8.5 15.9 8.1Z'/%3E%3C/svg%3E"); }
        .leaf2 { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23dc2626'%3E%3Cpath d='M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM15.9 8.1C15.5 7.7 14.8 7.5 14.2 7.8L12 9L9.8 7.8C9.2 7.5 8.5 7.7 8.1 8.1C7.7 8.5 7.5 9.2 7.8 9.8L9 12L7.8 14.2C7.5 14.8 7.7 15.5 8.1 15.9C8.5 16.3 9.2 16.5 9.8 16.2L12 15L14.2 16.2C14.8 16.5 15.5 16.3 15.9 15.9C16.3 15.5 16.5 14.8 16.2 14.2L15 12L16.2 9.8C16.5 9.2 16.3 8.5 15.9 8.1Z'/%3E%3C/svg%3E"); }
        .leaf3 { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23c2410c'%3E%3Cpath d='M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM15.9 8.1C15.5 7.7 14.8 7.5 14.2 7.8L12 9L9.8 7.8C9.2 7.5 8.5 7.7 8.1 8.1C7.7 8.5 7.5 9.2 7.8 9.8L9 12L7.8 14.2C7.5 14.8 7.7 15.5 8.1 15.9C8.5 16.3 9.2 16.5 9.8 16.2L12 15L14.2 16.2C14.8 16.5 15.5 16.3 15.9 15.9C16.3 15.5 16.5 14.8 16.2 14.2L15 12L16.2 9.8C16.5 9.2 16.3 8.5 15.9 8.1Z'/%3E%3C/svg%3E"); }
        
        @keyframes fall {
            0% {
                transform: translateY(-100px) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(100vh) translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            z-index: 1;
            position: relative;
        }
        
        .header {
            margin-bottom: 20px;
        }
        
        .balance {
            font-size: 28px;
            font-weight: bold;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.7);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(251, 146, 60, 0.3);
            color: #7c2d12;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .balance-label {
            font-size: 18px;
            color: #ea580c;
            margin-bottom: 5px;
        }
        
        .balance-amount {
            font-size: 32px;
            color: #c2410c;
            font-weight: 800;
        }
        
        .main-menu {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
            flex: 1;
        }
        
        .menu-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .menu-btn {
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid rgba(251, 146, 60, 0.3);
            border-radius: 15px;
            padding: 20px 10px;
            color: #7c2d12;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .menu-btn:hover {
            background: rgba(255, 237, 213, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .menu-btn:active {
            transform: translateY(0);
        }
        
        .menu-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .coin-section {
            margin-top: auto;
            padding: 20px 0;
        }
        
        .coin-img {
            width: 240px;
            height: 240px;
            border-radius: 50%;
            margin: 0 auto;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            transition: transform 0.1s ease;
            border: 6px solid #ffd54f;
            background: radial-gradient(circle, #ffd54f 0%, #f59e0b 100%);
            user-select: none;
            overflow: hidden;
            position: relative;
        }
        
        .coin-img:before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.1) 90%);
            border-radius: 50%;
        }
        
        .coin-img img {
            width: 90%;
            height: 90%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .coin-img:active {
            transform: scale(0.95);
        }
        
        /* Стили для экрана рейтинга */
        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
            flex: 1;
            overflow-y: auto;
        }
        
        .screen.active {
            display: flex;
            flex-direction: column;
        }
        
        .back-btn {
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid rgba(251, 146, 60, 0.3);
            padding: 10px 15px;
            border-radius: 10px;
            color: #7c2d12;
            cursor: pointer;
            margin-bottom: 15px;
            font-size: 14px;
            align-self: flex-start;
            backdrop-filter: blur(10px);
        }
        
        .leaderboard {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            backdrop-filter: blur(10px);
            flex: 1;
            overflow-y: auto;
            border: 2px solid rgba(251, 146, 60, 0.3);
        }
        
        .leaderboard h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #7c2d12;
        }
        
        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 2px solid rgba(124, 45, 18, 0.3);
            font-weight: bold;
            margin-bottom: 5px;
            color: #7c2d12;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(124, 45, 18, 0.2);
            align-items: center;
            color: #7c2d12;
        }
        
        .leaderboard-item:last-child {
            border-bottom: none;
        }
        
        .rank {
            font-weight: bold;
            width: 40px;
            text-align: center;
            color: #ea580c;
        }
        
        .username {
            flex: 1;
            text-align: left;
            padding: 0 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .user-balance {
            font-weight: bold;
            color: #c2410c;
            width: 80px;
            text-align: right;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #a8a29e;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #a8a29e;
            font-style: italic;
        }
        
        .user-rank {
            background: rgba(255, 237, 213, 0.7);
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
            border: 2px solid rgba(251, 146, 60, 0.3);
            color: #7c2d12;
        }
        
        .status {
            margin-top: 15px;
            font-size: 12px;
            min-height: 20px;
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(251, 146, 60, 0.3);
        }
        
        .success { color: #166534; background: rgba(220, 252, 231, 0.7); }
        .error { color: #dc2626; background: rgba(254, 226, 226, 0.7); }
        .warning { color: #ca8a04; background: rgba(254, 249, 195, 0.7); }
        .info { color: #1d4ed8; background: rgba(219, 234, 254, 0.7); }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .debug-info {
            display: none;
            font-size: 10px;
            color: #a8a29e;
            margin-top: 10px;
            background: rgba(0,0,0,0.1);
            padding: 10px;
            border-radius: 5px;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Главное меню -->
        <div id="main-menu-screen" class="screen active">
            <div class="header">
                <div class="balance">
                    <div class="balance-label">Ваш счёт:</div>
                    <div class="balance-amount" id="balance">0 монет</div>
                </div>
            </div>
            
            <div class="main-menu">
                <!-- Первый ряд из 3 кнопок -->
                <div class="menu-row">
                    <button class="menu-btn" onclick="showScreen('top-screen')">
                        <div class="menu-icon">🏆</div>
                        Топ
                    </button>
                    
                    <button class="menu-btn" onclick="showScreen('shop-screen')">
                        <div class="menu-icon">🛒</div>
                        Магазин
                    </button>
                    
                    <button class="menu-btn" onclick="showScreen('games-screen')">
                        <div class="menu-icon">🎮</div>
                        Игры
                    </button>
                </div>
                
                <!-- Второй ряд из 3 кнопок -->
                <div class="menu-row">
                    <button class="menu-btn" onclick="showScreen('transfer-screen')">
                        <div class="menu-icon">↗️</div>
                        Перевести
                    </button>
                    
                    <button class="menu-btn" onclick="showScreen('catalog-screen')">
                        <div class="menu-icon">📦</div>
                        Каталог
                    </button>
                    
                    <button class="menu-btn" onclick="showScreen('referrals-screen')">
                        <div class="menu-icon">👥</div>
                        Рефералы
                    </button>
                </div>
            </div>
            
            <!-- Монета внизу -->
            <div class="coin-section">
                <div class="coin-img" id="coin">
                    <img src="https://i.postimg.cc/MKDXT0T1/photo-2025-08-30-12-22-24.jpg" alt="Coin" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIj48Y2lyY2xlIGN4PSIxMDAiIGN5PSIxMDAiIHI9IjkwIiBmaWxsPSIjZmZkNzAwIiBzdHJva2U9IiNkYWE1MjAiIHN0cm9rZS13aWR0aD0iNCIvPjx0ZXh0IHg9IjEwMCIgeT0iMTEwIiBmb250LXNpemU9IjI0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOGI3NTAwIj5DTElDSyE8L3RleHQ+PC9zdmc+'">
                </div>
            </div>
            
            <div class="status" id="status"></div>
        </div>

        <!-- Экран Топ (Рейтинг) -->
        <div id="top-screen" class="screen">
            <button class="back-btn" onclick="showScreen('main-menu-screen')">← Назад</button>
            <h2>🏆 Топ игроков</h2>
            
            <div class="user-rank" id="user-rank" style="display: none;">
                <strong>Ваше место:</strong> <span id="user-position">-</span>
            </div>
            
            <div class="leaderboard">
                <div class="leaderboard-header">
                    <span class="rank">Место</span>
                    <span class="username">Никнейм</span>
                    <span class="user-balance">Баланс</span>
                </div>
                
                <div id="leaderboard" class="loading">Загрузка рейтинга...</div>
            </div>
            
            <button class="back-btn" onclick="refreshLeaderboard()">🔄 Обновить</button>
        </div>

        <!-- Заглушки для остальных экранов -->
        <div id="shop-screen" class="screen">
            <button class="back-btn" onclick="showScreen('main-menu-screen')">← Назад</button>
            <h2>🛒 Магазин</h2>
            <div class="empty-state">
                Магазин скоро откроется!<br>
                <small>Здесь можно будет покупать улучшения</small>
            </div>
        </div>

        <div id="games-screen" class="screen">
            <button class="back-btn" onclick="showScreen('main-menu-screen')">← Назад</button>
            <h2>🎮 Игры</h2>
            <div class="empty-state">
                Игры скоро появятся!<br>
                <small>Здесь будут мини-игры для заработка</small>
            </div>
        </div>

        <div id="transfer-screen" class="screen">
            <button class="back-btn" onclick="showScreen('main-menu-screen')">← Назад</button>
            <h2>↗️ Перевести</h2>
            <div class="empty-state">
                Переводы скоро будут доступны!<br>
                <small>Переводите монеты друзьям</small>
            </div>
        </div>

        <div id="catalog-screen" class="screen">
            <button class="back-btn" onclick="showScreen('main-menu-screen')">← Назад</button>
            <h2>📦 Каталог</h2>
            <div class="empty-state">
                Каталог в разработке!<br>
                <small>Покупайте предметы и улучшения</small>
            </div>
        </div>

        <div id="referrals-screen" class="screen">
            <button class="back-btn" onclick="showScreen('main-menu-screen')">← Назад</button>
            <h2>👥 Рефералы</h2>
            <div class="empty-state">
                Реферальная система скоро!<br>
                <small>Приглашайте друзей и получайте бонусы</small>
            </div>
        </div>

        <div id="debug" class="debug-info"></div>
    </div>

    <script>
        // Глобальные функции для навигации
        function showScreen(screenId) {
            console.log('Показываем экран:', screenId);
            
            // Скрыть все экраны
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Показать выбранный экран
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                
                // Если открываем топ - загружаем рейтинг
                if (screenId === 'top-screen') {
                    refreshLeaderboard();
                }
            }
        }

        function refreshLeaderboard() {
            if (window.coinApp) {
                window.coinApp.loadLeaderboard();
            }
        }

        function saveToCloud() {
            if (window.coinApp) {
                window.coinApp.saveToCloud();
            }
        }

        function toggleDebug() {
            const debugElement = document.getElementById('debug');
            if (debugElement) {
                debugElement.style.display = debugElement.style.display === 'none' ? 'block' : 'none';
            }
        }

        class CoinClicker {
            constructor() {
                this.userId = null;
                this.balance = 0;
                this.telegram = null;
                this.scriptURL = 'https://script.google.com/macros/s/AKfycby0jP0bpzlVyVoIqFGGoWI1dqrVVit7c18JQf2XE6mLJcxRfK_XvQvYbiq1Xts1c60ANw/exec';
                this.lastSaveTime = 0;
                this.isSaving = false;
                this.scriptAvailable = false;
                this.init();
            }

            async init() {
                try {
                    this.debugLog('Начало инициализации');
                    
                    // Инициализация Telegram Web App
                    if (window.Telegram && window.Telegram.WebApp) {
                        this.telegram = window.Telegram.WebApp;
                        this.telegram.expand();
                        this.userId = this.telegram.initDataUnsafe.user?.id;
                        this.debugLog('Telegram user ID: ' + this.userId);
                    }
                    
                    if (!this.userId) {
                        this.userId = 'guest_' + Math.random().toString(36).substr(2, 9);
                        this.debugLog('Generated guest ID: ' + this.userId);
                    }

                    // Загружаем из локального хранилища
                    this.loadFromLocal();
                    
                    // Показываем текущий баланс
                    this.updateBalanceDisplay();
                    
                    // Настраиваем обработчик клика на монету
                    this.setupCoinClick();
                    
                    // Проверяем доступность скрипта
                    this.checkScriptAvailability();
                    
                    // Создаем падающие листья
                    this.createFallingLeaves();
                    
                    this.showStatus('Кликайте на монету!', 'success');
                    
                } catch (error) {
                    console.error('Ошибка инициализации:', error);
                    this.debugLog('Ошибка инициализации: ' + error.message);
                }
            }

            createFallingLeaves() {
                const leafTypes = ['leaf1', 'leaf2', 'leaf3'];
                const body = document.body;
                
                // Создаем 15 листьев
                for (let i = 0; i < 15; i++) {
                    const leaf = document.createElement('div');
                    leaf.className = 'leaf ' + leafTypes[Math.floor(Math.random() * leafTypes.length)];
                    
                    // Случайная позиция по горизонтали
                    const left = Math.random() * 100;
                    leaf.style.left = left + 'vw';
                    
                    // Случайная задержка анимации
                    const delay = Math.random() * 15;
                    leaf.style.animationDelay = delay + 's';
                    
                    // Случайная длительность анимации
                    const duration = 10 + Math.random() * 20;
                    leaf.style.animationDuration = duration + 's';
                    
                    body.appendChild(leaf);
                }
            }

            setupCoinClick() {
                const coin = document.getElementById('coin');
                let lastClickTime = 0;
                
                const handleClick = () => {
                    const now = Date.now();
                    if (now - lastClickTime < 100) return;
                    lastClickTime = now;
                    
                    this.balance++;
                    this.updateBalanceDisplay();
                    this.saveToLocal();
                    
                    // Анимация клика
                    coin.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        coin.style.transform = 'scale(1)';
                    }, 100);
                    
                    this.showStatus('+1 монета! 💰', 'success');
                };
                
                coin.addEventListener('click', handleClick);
                coin.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    handleClick();
                }, { passive: false });
            }

            debugLog(message) {
                const debugElement = document.getElementById('debug');
                if (debugElement) {
                    debugElement.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
                    debugElement.scrollTop = debugElement.scrollHeight;
                }
                console.log(message);
            }

            async checkScriptAvailability() {
                try {
                    this.scriptAvailable = await this.testScriptConnection();
                    this.debugLog('Script available: ' + this.scriptAvailable);
                    
                    if (this.scriptAvailable) {
                        // Загружаем из облака в фоне
                        setTimeout(() => this.loadFromCloud().catch(() => {}), 1000);
                    }
                } catch (error) {
                    this.debugLog('Ошибка проверки скрипта: ' + error.message);
                    this.scriptAvailable = false;
                }
            }

            async testScriptConnection() {
                try {
                    const testUrl = `${this.scriptURL}?action=test&t=${Date.now()}`;
                    const response = await fetch(testUrl, { 
                        method: 'GET',
                        headers: {
                            'Content-Type': 'text/plain'
                        }
                    });
                    
                    return response.ok;
                } catch (error) {
                    return false;
                }
            }

            updateBalanceDisplay() {
                if (this.balance > 1000000) {
                    this.debugLog('Обнаружен слишком большой баланс: ' + this.balance + ', сбрасываем до 0');
                    this.balance = 0;
                }
                
                document.getElementById('balance').textContent = `${this.balance} монет`;
            }

            async makeRequest(url, options = {}) {
                try {
                    const response = await fetch(url, {
                        ...options,
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            ...options.headers
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error: ${response.status}`);
                    }
                    
                    const text = await response.text();
                    
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        return { success: false, error: 'Invalid JSON response' };
                    }
                    
                } catch (error) {
                    throw error;
                }
            }

            async saveToCloud() {
                if (!this.scriptAvailable) {
                    this.showStatus('Облачное сохранение недоступно ⚠️', 'warning');
                    return false;
                }
                
                if (this.isSaving) return false;
                this.isSaving = true;
                
                try {
                    this.showStatus('Сохранение...', 'loading');
                    this.debugLog('Сохранение в облако: ' + this.balance);
                    
                    const data = {
                        action: 'update',
                        userId: this.userId,
                        balance: this.balance,
                        username: this.telegram?.initDataUnsafe.user?.username || 'Гость',
                        firstName: this.telegram?.initDataUnsafe.user?.first_name || 'Игрок'
                    };

                    const formData = new URLSearchParams();
                    for (const key in data) {
                        formData.append(key, data[key]);
                    }

                    const response = await this.makeRequest(this.scriptURL, {
                        method: 'POST',
                        body: formData
                    });

                    if (response && response.success) {
                        this.lastSaveTime = Date.now();
                        this.showStatus('Сохранено! ✅', 'success');
                        return true;
                    } else {
                        throw new Error(response?.error || 'Ошибка сохранения');
                    }
                } catch (error) {
                    this.showStatus('Ошибка сохранения', 'error');
                    return false;
                } finally {
                    this.isSaving = false;
                }
            }

            async loadFromCloud() {
                if (!this.scriptAvailable) {
                    return false;
                }
                
                try {
                    this.debugLog('Загрузка из облака...');
                    
                    const url = `${this.scriptURL}?action=get&userId=${encodeURIComponent(this.userId)}&t=${Date.now()}`;
                    const data = await this.makeRequest(url);
                    
                    if (data && data.success && data.balance !== undefined && data.balance !== null) {
                        const cloudBalance = parseInt(data.balance);
                        
                        if (!isNaN(cloudBalance) && cloudBalance >= 0 && cloudBalance <= 1000000) {
                            this.balance = cloudBalance;
                            this.updateBalanceDisplay();
                            this.saveToLocal();
                            return true;
                        }
                    }
                    return false;
                } catch (error) {
                    return false;
                }
            }

            loadFromLocal() {
                try {
                    const saved = localStorage.getItem(`coin_balance_${this.userId}`);
                    if (saved) {
                        const balance = parseInt(saved);
                        if (!isNaN(balance) && balance >= 0 && balance <= 1000000) {
                            this.balance = balance;
                        }
                    }
                } catch (error) {
                    this.balance = 0;
                }
            }

            saveToLocal() {
                try {
                    localStorage.setItem(`coin_balance_${this.userId}`, this.balance.toString());
                } catch (error) {
                    console.error('Ошибка сохранения в localStorage:', error);
                }
            }

            async loadLeaderboard() {
                if (!this.scriptAvailable) {
                    // Показываем локальный рейтинг, если облачный недоступен
                    this.showLocalLeaderboard();
                    return;
                }
                
                try {
                    const leaderboardElement = document.getElementById('leaderboard');
                    leaderboardElement.innerHTML = '<div class="loading">Загрузка рейтинга...</div>';
                    
                    const url = `${this.scriptURL}?action=leaderboard&t=${Date.now()}`;
                    const data = await this.makeRequest(url);
                    
                    if (data && data.success) {
                        if (data.leaderboard && data.leaderboard.length > 0) {
                            this.displayLeaderboard(data.leaderboard);
                            this.displayUserRank(data.leaderboard);
                        } else {
                            this.showLocalLeaderboard();
                        }
                    } else {
                        this.showLocalLeaderboard();
                    }
                } catch (error) {
                    this.showLocalLeaderboard();
                }
            }

            // Показать локальный рейтинг (если облачный недоступен)
            showLocalLeaderboard() {
                const leaderboardElement = document.getElementById('leaderboard');
                
                // Получаем всех пользователей из localStorage
                const users = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('coin_balance_')) {
                        const userId = key.replace('coin_balance_', '');
                        const balance = parseInt(localStorage.getItem(key));
                        if (!isNaN(balance)) {
                            users.push({
                                userId: userId,
                                balance: balance,
                                username: userId.startsWith('guest_') ? 'Гость' : 'Игрок'
                            });
                        }
                    }
                }
                
                // Сортируем по балансу
                users.sort((a, b) => b.balance - a.balance);
                
                if (users.length > 0) {
                    this.displayLeaderboard(users);
                    this.displayUserRank(users);
                } else {
                    this.showEmptyLeaderboard();
                }
            }

            displayLeaderboard(leaderboard) {
                const leaderboardElement = document.getElementById('leaderboard');
                
                let html = '';
                const topPlayers = leaderboard.slice(0, 20);
                
                if (topPlayers.length === 0) {
                    this.showEmptyLeaderboard();
                    return;
                }
                
                topPlayers.forEach((player, index) {
                    const displayName = player.username || player.firstName || `Игрок ${(player.userId || '').substr(0, 6)}`;
                    const balance = player.balance || 0;
                    
                    html += `
                        <div class="leaderboard-item">
                            <span class="rank">${index + 1}</span>
                            <span class="username">${this.escapeHtml(displayName)}</span>
                            <span class="user-balance">${balance}</span>
                        </div>
                    `;
                });
                
                leaderboardElement.innerHTML = html;
            }

            showEmptyLeaderboard() {
                const leaderboardElement = document.getElementById('leaderboard');
                leaderboardElement.innerHTML = `
                    <div class="empty-state">
                        🏆 Рейтинг пуст<br>
                        <small>Станьте первым в рейтинге!</small>
                    </div>
                `;
            }

            displayUserRank(leaderboard) {
                const userRankElement = document.getElementById('user-rank');
                const userPositionElement = document.getElementById('user-position');
                
                if (!leaderboard || leaderboard.length === 0) {
                    userRankElement.style.display = 'none';
                    return;
                }

                const userIndex = leaderboard.findIndex(player => 
                    player.userId && player.userId.toString() === this.userId.toString()
                );
                
                if (userIndex !== -1) {
                    userPositionElement.textContent = `${userIndex + 1} место`;
                    userRankElement.style.display = 'block';
                } else {
                    userRankElement.style.display = 'none';
                }
            }

            showStatus(message, type = 'info') {
                const statusElement = document.getElementById('status');
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = `status ${type}`;
                    
                    if (type !== 'loading') {
                        setTimeout(() => {
                            if (statusElement.textContent === message) {
                                statusElement.textContent = '';
                                statusElement.className = 'status';
                            }
                        }, 3000);
                    }
                }
            }

            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            window.coinApp = new CoinClicker();
            
            // Добавляем двойной клик для отладки
            document.addEventListener('dblclick', toggleDebug);
            
            // Автосохранение каждые 30 секунд
            setInterval(() => {
                if (window.coinApp) {
                    window.coinApp.saveToCloud();
                }
            }, 30000);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>Coin Clicker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            margin: 0;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .balance { 
            font-size: 24px; 
            margin: 25px 0;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        #coins {
            font-size: 32px;
            color: #feca57;
            font-weight: bold;
        }
        .coin-btn {
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, #feca57 30%, #ff9f43 100%);
            border: 5px solid #ff9f43;
            border-radius: 50%;
            margin: 20px auto;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
        }
        .coin-btn:active {
            transform: scale(0.95);
        }
        .menu {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        .menu-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        .menu-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            padding: 20px;
            border-radius: 15px;
            width: 80%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .transfer-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        .transfer-form input {
            padding: 10px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .transfer-form input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .transfer-form button {
            padding: 10px;
            border-radius: 5px;
            border: none;
            background: #feca57;
            color: #333;
            font-weight: bold;
            cursor: pointer;
        }
        .error {
            color: #ff6b6b;
            margin-top: 5px;
            font-size: 14px;
        }
        .success {
            color: #1dd1a1;
            margin-top: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Coin Clicker</h1>
        <div class="balance">
            –í–∞—à –±–∞–ª–∞–Ω—Å: <span id="coins">0</span> ü™ô
        </div>
        
        <div class="coin-btn" id="coinBtn">
            ü™ô
        </div>
        
        <div class="menu">
            <button class="menu-btn" id="leaderboardBtn">–¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</button>
            <button class="menu-btn" id="transferBtn">–ü–µ—Ä–µ–≤–æ–¥</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ç–æ–ø–∞ –∏–≥—Ä–æ–∫–æ–≤ -->
    <div class="modal" id="leaderboardModal">
        <div class="modal-content">
            <span class="close" id="closeLeaderboard">&times;</span>
            <h2>–¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2>
            <div id="leaderboardList"></div>
            <div id="userRank"></div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ -->
    <div class="modal" id="transferModal">
        <div class="modal-content">
            <span class="close" id="closeTransfer">&times;</span>
            <h2>–ü–µ—Ä–µ–≤–æ–¥ –º–æ–Ω–µ—Ç</h2>
            <div class="transfer-form">
                <input type="text" id="recipientId" placeholder="ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è">
                <input type="number" id="transferAmount" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç">
                <button id="submitTransfer">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                <div id="transferResult"></div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let tg = null;
        let userData = null;
        const APP_URL = "https://script.google.com/macros/s/AKfycbx2Q0hH5WQvQZtWg5HqGQ2qJ4Z7X3Q2Q9Q8Q7Q6Q5Q4Q3Q2Q1/exec"; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL Apps Script

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
            tg = window.Telegram.WebApp;
            tg.expand();
            
            // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const savedUserData = localStorage.getItem('coinClickerUserData');
            
            if (savedUserData) {
                userData = JSON.parse(savedUserData);
                updateUI();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            initUser();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('coinBtn').addEventListener('click', handleCoinClick);
            document.getElementById('leaderboardBtn').addEventListener('click', showLeaderboard);
            document.getElementById('transferBtn').addEventListener('click', showTransferModal);
            document.getElementById('closeLeaderboard').addEventListener('click', closeLeaderboard);
            document.getElementById('closeTransfer').addEventListener('click', closeTransferModal);
            document.getElementById('submitTransfer').addEventListener('click', handleTransfer);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö –æ–±–ª–∞—Å—Ç–∏
            window.addEventListener('click', function(event) {
                if (event.target === document.getElementById('leaderboardModal')) {
                    closeLeaderboard();
                }
                if (event.target === document.getElementById('transferModal')) {
                    closeTransferModal();
                }
            });
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function initUser() {
            try {
                // –ï—Å–ª–∏ —É –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
                if (userData && userData.telegram_id) {
                    const response = await fetch(APP_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            method: 'getUser',
                            telegramId: userData.telegram_id
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", data.error);
                        createNewUser();
                    } else {
                        userData = data;
                        saveUserData();
                        updateUI();
                    }
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    createNewUser();
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function createNewUser() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram Web App
                const initData = tg.initDataUnsafe;
                const telegramId = initData.user?.id || tg.initData;
                const username = initData.user?.username || '';
                const firstName = initData.user?.first_name || 'User';
                
                if (!telegramId) {
                    console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
                    return;
                }
                
                const response = await fetch(APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        method: 'getUser',
                        telegramId: telegramId,
                        username: username,
                        first_name: firstName
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", data.error);
                } else {
                    userData = data;
                    saveUserData();
                    updateUI();
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage
        function saveUserData() {
            if (userData) {
                localStorage.setItem('coinClickerUserData', JSON.stringify(userData));
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            if (userData && userData.coins !== undefined) {
                document.getElementById('coins').textContent = userData.coins;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –º–æ–Ω–µ—Ç–µ
        async function handleCoinClick() {
            if (!userData || !userData.telegram_id) {
                console.error("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã");
                return;
            }
            
            try {
                const response = await fetch(APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        method: 'click',
                        telegramId: userData.telegram_id
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    console.error("–û—à–∏–±–∫–∞ –∫–ª–∏–∫–∞:", data.error);
                } else if (data.success) {
                    userData.coins = data.newCoins;
                    saveUserData();
                    updateUI();
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è –∫–ª–∏–∫–∞
                    const coinBtn = document.getElementById('coinBtn');
                    coinBtn.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        coinBtn.style.transform = 'scale(1)';
                    }, 100);
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–ª–∏–∫–∞:", error);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤
        async function showLeaderboard() {
            if (!userData || !userData.telegram_id) {
                console.error("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã");
                return;
            }
            
            try {
                const response = await fetch(APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        method: 'getTop',
                        telegramId: userData.telegram_id
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–ø–∞:", data.error);
                } else if (data.success) {
                    const leaderboardList = document.getElementById('leaderboardList');
                    leaderboardList.innerHTML = '';
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–ø-10 –∏–≥—Ä–æ–∫–æ–≤
                    data.topPlayers.slice(0, 10).forEach((player, index) => {
                        const item = document.createElement('div');
                        item.className = 'leaderboard-item';
                        item.innerHTML = `
                            <span>${index + 1}. ${player.name}${player.username ? ` (@${player.username})` : ''}</span>
                            <span>${player.coins} ü™ô</span>
                        `;
                        leaderboardList.appendChild(item);
                    });
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Å—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const userRank = document.getElementById('userRank');
                    if (data.userRank) {
                        userRank.innerHTML = `<p>–í–∞—à–µ –º–µ—Å—Ç–æ: ${data.userRank}</p>`;
                    } else {
                        userRank.innerHTML = `<p>–í—ã –µ—â–µ –Ω–µ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ</p>`;
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    document.getElementById('leaderboardModal').style.display = 'flex';
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–ø–∞:", error);
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤
        function closeLeaderboard() {
            document.getElementById('leaderboardModal').style.display = 'none';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–µ–≤–æ–¥–∞
        function showTransferModal() {
            document.getElementById('transferModal').style.display = 'flex';
            document.getElementById('transferResult').innerHTML = '';
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–µ–≤–æ–¥–∞
        function closeTransferModal() {
            document.getElementById('transferModal').style.display = 'none';
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ –º–æ–Ω–µ—Ç
        async function handleTransfer() {
            const recipientId = document.getElementById('recipientId').value;
            const amount = parseInt(document.getElementById('transferAmount').value);
            const resultElement = document.getElementById('transferResult');
            
            if (!recipientId || !amount) {
                resultElement.innerHTML = '<div class="error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è</div>';
                return;
            }
            
            if (amount <= 0) {
                resultElement.innerHTML = '<div class="error">–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ</div>';
                return;
            }
            
            if (!userData || !userData.telegram_id) {
                resultElement.innerHTML = '<div class="error">–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>';
                return;
            }
            
            if (userData.coins < amount) {
                resultElement.innerHTML = '<div class="error">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç</div>';
                return;
            }
            
            try {
                const response = await fetch(APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        method: 'transfer',
                        fromTelegramId: userData.telegram_id,
                        toTelegramId: recipientId,
                        amount: amount
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    resultElement.innerHTML = `<div class="error">${data.error}</div>`;
                } else if (data.success) {
                    resultElement.innerHTML = '<div class="success">–ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!</div>';
                    userData.coins = data.fromNewBalance;
                    saveUserData();
                    updateUI();
                    
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
                    document.getElementById('recipientId').value = '';
                    document.getElementById('transferAmount').value = '';
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ:", error);
                resultElement.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–µ—Ä–µ–≤–æ–¥–∞</div>';
            }
        }
    </script>
</body>
</html>
